# fin-infra

Complete financial and billing infrastructure for payments, subscriptions, invoicing, and usage-based billing. Built on Stripe with flexibility for any billing model.

## Installation

```bash
pip install fin-infra
```

Or with Poetry:

```bash
poetry add fin-infra
```

## Quick Example

Set up billing for your application:

```python
from fin_infra import Billing, StripeProvider

billing = Billing(
    provider=StripeProvider(api_key="sk_..."),
    webhook_secret="whsec_..."
)

# Create a subscription
subscription = await billing.create_subscription(
    customer_id="cus_123",
    price_id="price_456"
)
```

## Features

### Stripe Integration

Seamless Stripe integration with automatic webhook handling and event routing.

```python
from fin_infra import Billing, StripeProvider

billing = Billing(provider=StripeProvider())

# Create a customer
customer = await billing.create_customer(
    email="user@example.com",
    name="Alice Smith"
)

# Create a payment intent
intent = await billing.create_payment_intent(
    amount=2000,  # $20.00
    currency="usd",
    customer_id=customer.id
)
```

### Subscriptions

Manage recurring billing with support for trials, prorations, and plan changes.

```python
# Create subscription with trial
subscription = await billing.create_subscription(
    customer_id=customer.id,
    price_id="price_monthly",
    trial_days=14
)

# Upgrade plan
await billing.update_subscription(
    subscription_id=subscription.id,
    price_id="price_annual",
    prorate=True
)

# Cancel at period end
await billing.cancel_subscription(
    subscription_id=subscription.id,
    at_period_end=True
)
```

### Usage-Based Billing

Track and bill for metered usage with automatic aggregation.

```python
from fin_infra import UsageMeter

meter = UsageMeter(billing)

# Record usage
await meter.record(
    subscription_id=subscription.id,
    metric="api_calls",
    quantity=100
)

# Get usage summary
usage = await meter.get_usage(
    subscription_id=subscription.id,
    start_date="2024-01-01",
    end_date="2024-01-31"
)
```

### Invoicing

Generate and manage invoices with line items, taxes, and discounts.

```python
# Create invoice
invoice = await billing.create_invoice(
    customer_id=customer.id,
    items=[
        {"description": "Pro Plan", "amount": 4900},
        {"description": "API Calls (1000)", "amount": 1000}
    ],
    tax_rate=0.08
)

# Send invoice
await billing.send_invoice(invoice.id)

# Mark as paid
await billing.pay_invoice(invoice.id)
```

### Webhook Handling

fin-infra handles Stripe webhooks automatically with built-in signature verification and event routing.

```python
from fin_infra import webhook_handler

@webhook_handler("customer.subscription.created")
async def on_subscription_created(event):
    subscription = event.data.object
    await activate_user(subscription.customer)

@webhook_handler("invoice.payment_failed")
async def on_payment_failed(event):
    invoice = event.data.object
    await notify_user(invoice.customer, "Payment failed")
```

### Customer Portal

Redirect customers to a hosted portal for managing their billing.

```python
# Create portal session
session = await billing.create_portal_session(
    customer_id=customer.id,
    return_url="https://app.example.com/settings"
)

# Redirect user to session.url
```

## Pricing Models

fin-infra supports various pricing models out of the box:

| Model | Description |
|-------|-------------|
| Flat Rate | Fixed monthly/yearly pricing |
| Per Seat | Charge per user or seat |
| Usage Based | Pay for what you use |
| Tiered | Volume-based pricing tiers |
| Hybrid | Combination of models |

## Next Steps

- [Stripe Setup Guide](/docs/fin-infra/stripe)
- [Subscription Management](/docs/fin-infra/subscriptions)
- [Usage Billing](/docs/fin-infra/usage)
- [Invoice Generation](/docs/fin-infra/invoices)
- [Webhook Configuration](/docs/fin-infra/webhooks)
